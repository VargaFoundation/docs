"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[6675],{6967:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>s,metadata:()=>i,toc:()=>d});const i=JSON.parse('{"id":"tarn/operations","title":"Operations","description":"Node Tagging and Placement","source":"@site/docs/tarn/operations.md","sourceDirName":"tarn","slug":"/tarn/operations","permalink":"/tarn/operations","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/tarn/operations.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{"id":"operations","title":"Operations","sidebar_position":5},"sidebar":"tutorialSidebar","previous":{"title":"Configuration","permalink":"/tarn/configuration"},"next":{"title":"Security","permalink":"/tarn/security"}}');var r=t(4848),o=t(8453);const s={id:"operations",title:"Operations",sidebar_position:5},a=void 0,l={},d=[{value:"Node Tagging and Placement",id:"node-tagging-and-placement",level:2},{value:"How to tag nodes in YARN",id:"how-to-tag-nodes-in-yarn",level:3},{value:"1. Using Node Labels (Recommended for GPU isolation)",id:"1-using-node-labels-recommended-for-gpu-isolation",level:4},{value:"2. Anti-Affinity via Placement Constraints",id:"2-anti-affinity-via-placement-constraints",level:4},{value:"Load Balancing Options",id:"load-balancing-options",level:2},{value:"Comparison and Recommendation",id:"comparison-and-recommendation",level:3},{value:"Option 1: Apache Knox with ZooKeeper (Recommended)",id:"option-1-apache-knox-with-zookeeper-recommended",level:3},{value:"How it Works:",id:"how-it-works",level:4},{value:"1. AM Configuration for ZooKeeper",id:"1-am-configuration-for-zookeeper",level:4},{value:"2. Knox Topology Configuration",id:"2-knox-topology-configuration",level:4},{value:"Option 2: HAProxy with Dynamic Update Script",id:"option-2-haproxy-with-dynamic-update-script",level:3},{value:"How it Works:",id:"how-it-works-1",level:4},{value:"1. HAProxy Installation",id:"1-haproxy-installation",level:4},{value:"2. HAProxy Configuration",id:"2-haproxy-configuration",level:4},{value:"3. Permissions and Script Usage",id:"3-permissions-and-script-usage",level:4},{value:"Running as a Service",id:"running-as-a-service",level:4},{value:"Monitoring with Grafana",id:"monitoring-with-grafana",level:2}];function c(e){const n={code:"code",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h2,{id:"node-tagging-and-placement",children:"Node Tagging and Placement"}),"\n",(0,r.jsxs)(n.p,{children:["TARN uses YARN ",(0,r.jsx)(n.strong,{children:"Placement Constraints"})," to ensure optimal distribution of Triton instances. By default, it uses the tag ",(0,r.jsx)(n.code,{children:"nvidia"})," for anti-affinity (at most one container per node)."]}),"\n",(0,r.jsx)(n.h3,{id:"how-to-tag-nodes-in-yarn",children:"How to tag nodes in YARN"}),"\n",(0,r.jsxs)(n.p,{children:["To use placement constraints effectively, you may want to tag your nodes. In YARN, this is typically done using ",(0,r.jsx)(n.strong,{children:"Node Labels"})," or by configuring the NodeManagers."]}),"\n",(0,r.jsx)(n.h4,{id:"1-using-node-labels-recommended-for-gpu-isolation",children:"1. Using Node Labels (Recommended for GPU isolation)"}),"\n",(0,r.jsx)(n.p,{children:"Node labels allow you to partition the cluster. For example, to label nodes with GPUs:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:'# Add the label\r\nyarn rmadmin -replaceLabelsOnNode "node1:8041,GPU node2:8041,GPU"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Then, you can configure your queue to use these labels. Note that TARN also explicitly requests ",(0,r.jsx)(n.code,{children:"yarn.io/gpu"})," resources."]}),"\n",(0,r.jsx)(n.h4,{id:"2-anti-affinity-via-placement-constraints",children:"2. Anti-Affinity via Placement Constraints"}),"\n",(0,r.jsxs)(n.p,{children:["TARN automatically handles anti-affinity. If you use the ",(0,r.jsx)(n.code,{children:"--placement-tag"})," option, TARN will:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Tag all its Triton containers with this value."}),"\n",(0,r.jsx)(n.li,{children:"Tell YARN to never place two containers with the same tag on the same node."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"This ensures that even if you have multiple GPUs on a single node, a single Triton instance (which can manage multiple GPUs via TP/PP) will occupy that node, preventing resource contention between multiple Triton processes."}),"\n",(0,r.jsx)(n.h2,{id:"load-balancing-options",children:"Load Balancing Options"}),"\n",(0,r.jsxs)(n.p,{children:["TARN provides two distinct strategies for service discovery and load balancing, allowing you to choose the best fit for your infrastructure. ",(0,r.jsx)(n.strong,{children:"The ZooKeeper-based approach with Apache Knox is highly recommended for production environments."})]}),"\n",(0,r.jsx)(n.h3,{id:"comparison-and-recommendation",children:"Comparison and Recommendation"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Feature"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"Apache Knox + ZooKeeper (Recommended)"}),(0,r.jsx)(n.th,{style:{textAlign:"left"},children:"HAProxy + Update Script"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Primary Use Case"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Production, Multi-tenant clusters"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Standalone, Simple environments"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Discovery Mechanism"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Native ZK Watches (Push-based)"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"AM Polling via Script (Pull-based)"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Security"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Kerberos, LDAP, Knox Dispatchers, Audit"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Basic Token-based Discovery"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"High Availability"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Built-in via Knox HaProvider"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Requires External Script Management"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{style:{textAlign:"left"},children:(0,r.jsx)(n.strong,{children:"Complexity"})}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Higher (requires Knox & ZooKeeper)"}),(0,r.jsx)(n.td,{style:{textAlign:"left"},children:"Lower (requires HAProxy & socat)"})]})]})]}),"\n",(0,r.jsx)(n.h3,{id:"option-1-apache-knox-with-zookeeper-recommended",children:"Option 1: Apache Knox with ZooKeeper (Recommended)"}),"\n",(0,r.jsxs)(n.p,{children:["This method leverages ",(0,r.jsx)(n.strong,{children:"Apache ZooKeeper"})," for real-time service discovery and ",(0,r.jsx)(n.strong,{children:"Apache Knox"})," as a secure perimeter gateway."]}),"\n",(0,r.jsx)(n.h4,{id:"how-it-works",children:"How it Works:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Ephemeral Registration"}),": The TARN Application Master (AM) automatically registers every new Triton container as an ",(0,r.jsx)(n.strong,{children:"ephemeral znode"})," in ZooKeeper under the configured path (e.g., ",(0,r.jsx)(n.code,{children:"/services/triton/instances/container_id"}),")."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Liveness Monitoring"}),": If a container fails or is stopped by YARN, its znode is automatically removed from ZooKeeper by the cluster coordination."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Dynamic Discovery"}),": Apache Knox uses its ",(0,r.jsx)(n.code,{children:"HaProvider"})," to watch the ZooKeeper namespace. As soon as a znode appears or disappears, Knox updates its internal list of backends without any manual intervention."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Secure Proxying"}),": Clients interact with Knox via HTTPS. Knox handles authentication (LDAP, Kerberos) and then forwards requests to the healthy Triton instances."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"1-am-configuration-for-zookeeper",children:"1. AM Configuration for ZooKeeper"}),"\n",(0,r.jsx)(n.p,{children:"When submitting the application, provide the ZooKeeper ensemble and the base path where instances should register:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"yarn jar tarn-orchestrator.jar varga.tarn.yarn.Client \\\r\n  ... \\\r\n  --zk-ensemble zk-host1:2181,zk-host2:2181 \\\r\n  --zk-path /services/triton/instances\n"})}),"\n",(0,r.jsx)(n.h4,{id:"2-knox-topology-configuration",children:"2. Knox Topology Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Create a topology file (e.g., ",(0,r.jsx)(n.code,{children:"/etc/knox/conf/topologies/tarn.xml"}),") and enable the ",(0,r.jsx)(n.code,{children:"HaProvider"}),". This provider is responsible for talking to ZooKeeper and performing round-robin load balancing."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-xml",children:"<topology>\r\n    <gateway>\r\n        <provider>\r\n            <role>ha</role>\r\n            <name>HaProvider</name>\r\n            <enabled>true</enabled>\r\n            <param>\r\n                <name>TRITON</name>\r\n                <value>\r\n                    enabled=true;\r\n                    maxFailoverAttempts=3;\r\n                    failoverSleep=1000;\r\n                    zookeeperEnsemble=zk-host1:2181,zk-host2:2181;\r\n                    zookeeperNamespace=/services/triton\r\n                </value>\r\n            </param>\r\n        </provider>\r\n        \x3c!-- Add your ShiroProvider or Kerberos authentication here --\x3e\r\n    </gateway>\r\n    <service>\r\n        <role>TRITON</role>\r\n        \x3c!-- No URL is needed here as it is discovered via ZooKeeper --\x3e\r\n    </service>\r\n</topology>\n"})}),"\n",(0,r.jsx)(n.h3,{id:"option-2-haproxy-with-dynamic-update-script",children:"Option 2: HAProxy with Dynamic Update Script"}),"\n",(0,r.jsx)(n.p,{children:"This method is suitable for smaller deployments or environments where Apache Knox is not available. It relies on a sidecar script that polls the TARN Application Master."}),"\n",(0,r.jsx)(n.h4,{id:"how-it-works-1",children:"How it Works:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"AM Discovery"}),": The ",(0,r.jsx)(n.code,{children:"update_haproxy.sh"})," script uses the YARN CLI to find the current host and port of the Application Master."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Instance Polling"}),": Every 30 seconds (configurable), the script queries the AM's ",(0,r.jsx)(n.code,{children:"/instances"})," endpoint to get the list of active Triton containers."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Runtime API Update"}),": The script communicates with HAProxy via a Unix Socket using ",(0,r.jsx)(n.code,{children:"socat"}),". It uses the ",(0,r.jsx)(n.strong,{children:"Runtime API"})," to update server addresses and ports in real-time."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Slot Management"}),': HAProxy must be configured with "placeholder slots". The script maps active containers to these slots. Unused slots are put into ',(0,r.jsx)(n.code,{children:"MAINT"})," (maintenance) mode to stop traffic."]}),"\n"]}),"\n",(0,r.jsx)(n.h4,{id:"1-haproxy-installation",children:"1. HAProxy Installation"}),"\n",(0,r.jsxs)(n.p,{children:["Ensure both HAProxy and ",(0,r.jsx)(n.code,{children:"socat"})," are installed on the load balancer node:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Ubuntu/Debian\r\nsudo apt-get install haproxy socat\r\n# RHEL/CentOS\r\nsudo yum install haproxy socat\n"})}),"\n",(0,r.jsx)(n.h4,{id:"2-haproxy-configuration",children:"2. HAProxy Configuration"}),"\n",(0,r.jsxs)(n.p,{children:["Edit ",(0,r.jsx)(n.code,{children:"/etc/haproxy/haproxy.cfg"}),". You ",(0,r.jsx)(n.strong,{children:"must"})," enable the stats socket with ",(0,r.jsx)(n.code,{children:"level admin"})," to allow the script to make changes."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-haproxy",children:"global\r\n    # Mandatory for the update script\r\n    stats socket /var/run/haproxy.sock mode 660 level admin\r\n    stats timeout 30s\r\n\r\ndefaults\r\n    mode http\r\n    timeout connect 5s\r\n    timeout client 50s\r\n    timeout server 50s\r\n\r\nfrontend triton_frontend\r\n    bind *:80\r\n    default_backend triton_backend\r\n\r\nbackend triton_backend\r\n    balance roundrobin\r\n    # Define placeholder slots. \r\n    # Important: The number of slots must be >= your --max-instances setting.\r\n    server triton-1 0.0.0.0:8000 check disabled\r\n    server triton-2 0.0.0.0:8000 check disabled\r\n    server triton-3 0.0.0.0:8000 check disabled\r\n    server triton-4 0.0.0.0:8000 check disabled\n"})}),"\n",(0,r.jsx)(n.h4,{id:"3-permissions-and-script-usage",children:"3. Permissions and Script Usage"}),"\n",(0,r.jsx)(n.p,{children:"The user running the script needs write access to the HAProxy socket:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"sudo chown root:haproxy /var/run/haproxy.sock\r\nsudo chmod 660 /var/run/haproxy.sock\r\nsudo usermod -a -G haproxy $USER\n"})}),"\n",(0,r.jsx)(n.p,{children:"Run the script in the background or as a systemd service:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"./scripts/update_haproxy.sh /var/run/haproxy.sock <YOUR_TARN_TOKEN>\n"})}),"\n",(0,r.jsx)(n.h4,{id:"running-as-a-service",children:"Running as a Service"}),"\n",(0,r.jsxs)(n.p,{children:["A systemd unit file is provided in ",(0,r.jsx)(n.code,{children:"services/tarn-haproxy-updater.service"}),". To install it:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["Copy the script to ",(0,r.jsx)(n.code,{children:"/usr/local/bin/update_haproxy.sh"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Copy the service file to ",(0,r.jsx)(n.code,{children:"/etc/systemd/system/"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:["Update the ",(0,r.jsx)(n.code,{children:"ExecStart"})," and ",(0,r.jsx)(n.code,{children:"User"})," in the service file if necessary."]}),"\n",(0,r.jsxs)(n.li,{children:["Run ",(0,r.jsx)(n.code,{children:"systemctl daemon-reload && systemctl enable --now tarn-haproxy-updater"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"monitoring-with-grafana",children:"Monitoring with Grafana"}),"\n",(0,r.jsxs)(n.p,{children:["You can connect Grafana to the Application Master by adding a Prometheus data source pointing to:\r\n",(0,r.jsx)(n.code,{children:"http://<AM_HOST>:<AM_PORT>/metrics?token=<YOUR_TOKEN>"})]}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Available metrics:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tarn_target_containers"}),": Target number of containers for scaling."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tarn_running_containers"}),": Actual number of running containers."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tarn_container_load"}),": Per-container load based on GPU or request activity."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tarn_gpu_utilization"}),": Per-GPU utilization."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tarn_gpu_memory_used"}),": Per-GPU memory usage."]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>s,x:()=>a});var i=t(6540);const r={},o=i.createContext(r);function s(e){const n=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:s(e.components),i.createElement(o.Provider,{value:n},e.children)}}}]);